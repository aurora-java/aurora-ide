$A.Table=Ext.extend($A.Component,{bgc:"background-color",scor:"#dfeaf5",ocor:"#ffe3a8",cecls:"table-cell-editor",nbcls:"item-notBlank",initComponent:function(a){$A.Table.superclass.initComponent.call(this,a);var b=this.wrap;this.cb=b.child("div[atype=table.headcheck]");this.tbody=b.child("tbody");this.fb=b.child("tfoot");this.initTemplate()},processListener:function(a){$A.Table.superclass.processListener.call(this,a);this.tbody[a]("click",this.onClick,this);if(this.canwheel){this.tbody[a]("mousewheel",this.onMouseWheel,this)}if(this.cb){this.cb[a]("click",this.onHeadClick,this)}},processDataSetLiestener:function(a){var b=this.dataset;if(b){b[a]("ajaxfailed",this.onAjaxFailed,this);b[a]("metachange",this.onLoad,this);b[a]("update",this.onUpdate,this);b[a]("reject",this.onUpdate,this);b[a]("add",this.onAdd,this);b[a]("submit",this.onBeforSubmit,this);b[a]("submitfailed",this.onAfterSuccess,this);b[a]("submitsuccess",this.onAfterSuccess,this);b[a]("query",this.onBeforeLoad,this);b[a]("load",this.onLoad,this);b[a]("loadfailed",this.onAjaxFailed,this);b[a]("valid",this.onValid,this);b[a]("beforeremove",this.onBeforeRemove,this);b[a]("remove",this.onRemove,this);b[a]("clear",this.onLoad,this);b[a]("refresh",this.onLoad,this);b[a]("fieldchange",this.onFieldChange,this);b[a]("indexchange",this.onIndexChange,this);b[a]("select",this.onSelect,this);b[a]("unselect",this.onUnSelect,this)}},initEvents:function(){$A.Table.superclass.initEvents.call(this);this.addEvents("render","cellclick","rowclick","editorshow","nexteditorshow")},bind:function(a){if(typeof(a)==="string"){a=$(a);if(!a){return}}this.dataset=a;this.processDataSetLiestener("on");this.onLoad()},initTemplate:function(){this.cellTpl=new Ext.Template('<div class="table-cell {cellcls}" id="'+this.id+'_{name}_{recordid}">{text}</div>');this.cbTpl=new Ext.Template('<center><div class="{cellcls}" id="'+this.id+'_{name}_{recordid}"></div></center>')},createRow:function(b,c){var f=this.tbody.dom.insertRow(-1);var e=this.parseCss(this.renderRow(b,c));f.id=this.id+"-"+b.id;f.style.cssText=e.style;f.className=(c%2==1?"table-row-alt ":"")+e.cls;for(var d=0,a=this.columns.length;d<a;d++){this.createCell(f,this.columns[d],b)}},createEmptyRow:function(){this.emptyRow=this.tbody.dom.insertRow(-1);for(var c=0,a=this.columns.length;c<a;c++){var d=this.emptyRow.insertCell(-1),b=this.columns[c];d.innerHTML="&#160;";Ext.fly(d).set({atype:"table-cell",dataindex:b.name,style:"text-align:"+(b.align||"left")+(b.hidden?";display:none;":";")})}},removeEmptyRow:function(){if(this.emptyRow){this.tbody.dom.removeChild(this.emptyRow);this.emptyRow=null}},getCheckBoxStatus:function(a,d,c){var g=this.dataset.getField(d);var b=g.getPropertity("checkedvalue");var e=g.getPropertity("uncheckedvalue");var f=a.data[d];return"item-ckb-"+(c?"readonly-":"")+((f&&f==b)?"c":"u")},createCell:function(h,a,e){var i=e.getMeta().getField(a.name);if(i&&Ext.isEmpty(e.data[a.name])&&e.isNew==true&&i.get("required")==true){j=j+" "+this.nbcls}var f=this.getEditor(a,e),b=a.type,d,j,c;if(h.tagName.toLowerCase()=="tr"){c=h.insertCell(-1)}else{c=Ext.fly(h).parent("td").dom}if(f!=""){var g=$A.CmpManager.get(f);if(g&&(g instanceof $A.CheckBox)){b="cellcheck";j=""}else{j="table-cell-editor"}}else{if(a.name&&Ext.isDefined(e.getField(a.name).get("checkedvalue"))){b="cellcheck";d=true}}if(b=="rowcheck"||b=="rowradio"){if(!this.dataset.execSelectFunction(e)){d="-readonly"}else{d=""}Ext.fly(c).set({atype:b=="rowcheck"?"table.rowcheck":"table.rowradio",recordid:e.id,"class":"table-rowbox"});c.innerHTML=this.cbTpl.applyTemplate({cellcls:b=="rowcheck"?"table-ckb item-ckb"+d+"-u":"table-radio item-radio-img"+d+"-u",name:a.name,recordid:e.id})}else{Ext.fly(c).set({atype:"table-cell",recordid:e.id,dataindex:a.name,style:"text-align:"+(a.align||"left")+(a.hidden?";display:none;":";")});if(b=="cellcheck"){c.innerHTML=this.cbTpl.applyTemplate({cellcls:"table-ckb "+this.getCheckBoxStatus(e,a.name,d),name:a.name,recordid:e.id})}else{c.innerHTML=this.cellTpl.applyTemplate({text:this.renderText(e,a,e.data[a.name]),cellcls:j,name:a.name,recordid:e.id})}}},onSelect:function(c,b){var a=Ext.get(this.id+"__"+b.id);if(a&&this.selectable&&this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,true);this.setSelectStatus(b)}else{this.setRadioStatus(a,true);this.setSelectStatus(b)}},onUnSelect:function(c,b){var a=Ext.get(this.id+"__"+b.id);if(a&&this.selectable&&this.selectionmodel=="multiple"){this.setCheckBoxStatus(a,false);this.setSelectStatus(b)}else{this.setRadioStatus(a,false);this.setSelectStatus(b)}},setRadioStatus:function(a,b){if(!b){a.removeClass("item-radio-img-c");a.addClass("item-radio-img-u")}else{a.addClass("item-radio-img-c");a.removeClass("item-radio-img-u")}},setCheckBoxStatus:function(a,b){if(!b){a.removeClass("item-ckb-c");a.addClass("item-ckb-u")}else{a.addClass("item-ckb-c");a.removeClass("item-ckb-u")}},setSelectDisable:function(b,a){if(this.selectable&&this.selectionmodel=="multiple"){b.removeClass("item-ckb-c");b.removeClass("item-ckb-u");if(this.dataset.selected.indexOf(a)==-1){b.addClass("item-ckb-readonly-u")}else{b.addClass("item-ckb-readonly-c")}}else{b.removeClass(["item-radio-img-c","item-radio-img-u","item-radio-img-readonly-c","item-radio-img-readonly-u"]);if(this.dataset.selected.indexOf(a)==-1){b.addClass("item-radio-img-readonly-u")}else{b.addClass("item-radio-img-readonly-c")}}},setSelectEnable:function(b,a){if(this.selectable&&this.selectionmodel=="multiple"){b.removeClass("item-ckb-readonly-u");b.removeClass("item-ckb-readonly-c");if(this.dataset.selected.indexOf(a)==-1){b.addClass("item-ckb-u")}else{b.addClass("item-ckb-c")}}else{b.removeClass(["item-radio-img-u","item-radio-img-c","item-radio-img-readonly-u","item-radio-img-readonly-c"]);if(this.dataset.selected.indexOf(a)==-1){b.addClass("item-radio-img-u")}else{b.addClass("item-radio-img-c")}}},setSelectStatus:function(b){if(this.dataset.selectfunction){var a=Ext.get(this.id+"__"+b.id);if(!this.dataset.execSelectFunction(b)){this.setSelectDisable(a,b)}else{this.setSelectEnable(a,b)}}},onHeadClick:function(c){var a=this.cb;var b=a.hasClass("item-ckb-c");this.setCheckBoxStatus(a,!b);if(!b){this.dataset.selectAll()}else{this.dataset.unSelectAll()}},setEditor:function(b,c){var a=this.findColByName(b);a.editor=c;this.focusdiv=Ext.get(this.id+"_"+b+"_"+this.selectRecord.id);if(this.focusdiv){if(c==""){this.focusdiv.removeClass(this.cecls)}else{if(!$(c) instanceof $A.CheckBox){this.focusdiv.addClass(this.cecls)}}}},getEditor:function(d,b){var c=d.editor||"";if(d.editorfunction){var a=window[d.editorfunction];if(a==null){alert("未找到"+d.editorfunction+"方法!");return null}c=a.call(window,b,d.name)}return c},showEditor:function(j,a,i){if(j==-1){return}var b=this.findColByName(a);if(!b){return}var c=this.dataset.getAt(j);if(!c){return}if(c.id!=this.selectedId){this.selectRow(j)}var g=this.getEditor(b,c);this.setEditor(a,g);var f=this;if(f.currentEditor){f.currentEditor.editor.el.un("keydown",f.onEidtorKeyDown,f);var h=f.currentEditor.focusCheckBox;if(h){h.setStyle("outline","none");f.currentEditor.focusCheckBox=null}}if(g!=""){var e=$(g);setTimeout(function(){var d=c.get(a);f.currentEditor={record:c,ov:d,name:a,editor:e};var l=Ext.get(f.id+"_"+a+"_"+c.id);var k=l.getXY();e.bind(f.dataset,a);e.render(c);if(e instanceof $A.CheckBox){e.move(-1000,k[1]+5);e.el.on("keydown",f.onEidtorKeyDown,f);e.onClick();f.currentEditor.focusCheckBox=l;l.setStyle("outline","1px dotted blue")}else{if(g){f.positionEditor();e.isEditor=true;e.isFireEvent=true;e.isHidden=false;e.focus();f.editing=true;e.el.on("keydown",f.onEidtorKeyDown,f);Ext.fly(document.documentElement).on("mousedown",f.onEditorBlur,f);Ext.fly(window).on("resize",f.positionEditor,f);if(i){i.call(window,e)}f.fireEvent("editorshow",f,e,j,a,c)}}},10)}},onEidtorKeyDown:function(c,a){var b=c.keyCode;if(b==27){a.clearInvalid();a.render(a.binder.ds.getCurrentRecord());this.hideEditor()}if(b==13){if(!a instanceof $A.TextArea){this.showNextEditor()}}if(b==9){c.stopEvent();this.showNextEditor()}},showNextEditor:function(){this.hideEditor();var n=this;if(this.currentEditor&&this.currentEditor.editor){var q=function(d){if(d instanceof Aurora.Lov){d.showLovWindow()}};var k=this.currentEditor.editor,g=k.binder.ds,f=k.binder.name,a=k.record,t=g.data.indexOf(a),b=null;if(t!=-1){var s=this.columns;var c=0;for(var j=0,h=s.length;j<h;j++){if(s[j].name==f){c=j+1}}var m;for(var j=c,h=s.length;j<h;j++){var e=s[j];if(e.hidden!=true){m=this.getEditor(e,a);if(m!=""){b=e.name;break}}}if(n.currentEditor){var o=n.currentEditor.focusCheckBox;if(o){o.setStyle("outline","none");n.currentEditor.focusCheckBox=null}}if(b){var k=$(m);if(k instanceof $A.CheckBox){n.currentEditor={record:a,ov:a.get(b),name:b,editor:k};setTimeout(function(){k.bind(n.dataset,b);k.render(a);var i=Ext.get(n.id+"_"+b+"_"+a.id);var d=i.getXY();k.move(-1000,d[1]);k.focus();k.el.on("keydown",n.onEidtorKeyDown,n);n.currentEditor.focusCheckBox=i;i.setStyle("outline","1px dotted blue")},10)}else{this.fireEvent("cellclick",this,t,b,a);this.showEditor(t,b,q)}}else{var p=g.getAt(t+1);if(p){n.selectRow(t+1);for(var j=0,h=s.length;j<h;j++){var e=s[j];var m=this.getEditor(e,p);if(m!=""){var k=$(m),b=e.name;if(k instanceof $A.CheckBox){n.currentEditor={record:p,ov:p.get(b),name:b,editor:k};setTimeout(function(){k.bind(n.dataset,b);k.render(p);var i=Ext.get(n.id+"_"+b+"_"+p.id);var d=i.getXY();k.move(-1000,d[1]);k.focus();k.el.on("keydown",n.onEidtorKeyDown,n);n.currentEditor.focusCheckBox=i;i.setStyle("outline","1px dotted blue")},10)}else{this.fireEvent("cellclick",this,t+1,b,p);this.showEditor(t+1,b,q)}break}}}}}this.fireEvent("nexteditorshow",this,t,b)}},positionEditor:function(){var a=this.currentEditor.editor,d=this.focusdiv,c=d.getXY(),b=this;a.setHeight(d.getHeight()-2);a.setWidth(d.getWidth()-5<22?22:(d.getWidth()-5));a.move(c[0],c[1]);if(a.isExpanded&&a.isExpanded()){if(Ext.isIE){if(this.t){clearTimeout(this.t)}this.t=setTimeout(function(){a.syncPopup()},1)}else{a.syncPopup()}}},hideEditor:function(){if(this.currentEditor&&this.currentEditor.editor){var a=this.currentEditor.editor;var b=true;if(a.canHide){b=a.canHide()}if(b){a.el.un("keydown",this.onEidtorKeyDown,this);Ext.fly(document.documentElement).un("mousedown",this.onEditorBlur,this);Ext.fly(window).un("resize",this.positionEditor,this);var a=this.currentEditor.editor;a.move(-10000,-10000);a.onBlur();a.isFireEvent=false;a.isHidden=true}this.editing=false}},selectRow:function(d,b){var a=this.dataset.getAt(d);this.selectedId=a.id;if(this.selectTr){this.selectTr.setStyle(this.bgc,"")}this.selectTr=Ext.get(this.id+"-"+a.id);if(this.selectTr){this.selectTr.setStyle(this.bgc,this.scor)}var c=(this.dataset.currentPage-1)*this.dataset.pagesize+d+1;this.selectRecord=a;if(b!==false&&c!=null){this.dataset.locate.defer(5,this.dataset,[c,false])}},drawFootBar:function(b){if(!this.fb){return}b=[].concat((b)?b:this.columns);var a=this;Ext.each(b,function(h){var e=typeof(h)==="string"?a.findColByName(h):h;if(e&&e.footerrenderer){var d=e.name;var g=$A.getRenderer(e.footerrenderer);if(g==null){alert("未找到"+e.footerrenderer+"方法!");return}var c=g.call(window,a.dataset.data,d);if(!Ext.isEmpty(c)){var f=a.fb.child("td[dataindex="+d+"]");f.update(c)}}})},showColumn:function(c){var b=this.findColByName(c);if(b){if(b.hidden===true){delete b.hidden;var e=Ext.DomQuery.select("td[dataindex="+c+"]",this.wrap.dom);for(var d=0,a=e.length;d<a;d++){var f=e[d];Ext.fly(f).setStyle("display","")}}}},hideColumn:function(c){var b=this.findColByName(c);if(b){if(b.hidden!==true){var e=Ext.DomQuery.select("td[dataindex="+c+"]",this.wrap.dom);for(var d=0,a=e.length;d<a;d++){var f=e[d];Ext.fly(f).setStyle("display","none")}b.hidden=true}}},findColByName:function(d){var b;for(var e=0,a=this.columns.length;e<a;e++){var f=this.columns[e];if(f.name&&f.name.toLowerCase()===d.toLowerCase()){b=f;break}}return b},parseCss:function(c){var e="",a="";if(Ext.isArray(c)){for(var b=0;b<c.length;b++){var d=this.parseCss(c[b]);e+=";"+d.style;a+=" "+d.cls}}else{if(typeof c=="string"){isStyle=!!c.match(/^([^,:;]+:[^:;]+;)*[^,:;]+:[^:;]+;*$/);a=isStyle?"":c;e=isStyle?c:""}}return{style:e,cls:a}},renderText:function(a,b,e){var d=b.renderer;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return e}e=c.call(window,e,a,b.name);return e==null?"":e}return e==null?"":e},renderRow:function(a,e){var d=this.rowrenderer,b=null;if(d){var c=$A.getRenderer(d);if(c==null){alert("未找到"+d+"方法!");return b}b=c.call(window,a,e);return !b?"":b}return b},renderEditor:function(e,a,d,b){this.createCell(e.dom,d,a)},onClick:function(f){var g=Ext.fly(f.target).findParent("td");if(g){var b=Ext.fly(g).getAttributeNS("","atype");var i=Ext.fly(g).getAttributeNS("","recordid");if(b=="table-cell"){var d=this.dataset.findById(i);var j=this.dataset.indexOf(d);var a=Ext.fly(g).getAttributeNS("","dataindex");this.showEditor(j,a);this.fireEvent("cellclick",this,j,a,d);this.fireEvent("rowclick",this,j,d)}else{if(b=="table.rowcheck"){var c=Ext.get(this.id+"__"+i);if(c.hasClass("item-ckb-readonly-u")||c.hasClass("item-ckb-readonly-c")){return}var h=c.hasClass("item-ckb-c");(h)?this.dataset.unSelect(i):this.dataset.select(i)}else{if(b=="table.rowradio"){var c=Ext.get(this.id+"__"+i);if(c.hasClass("item-radio-img-readonly-u")||c.hasClass("item-radio-img-readonly-c")){return}this.dataset.select(i)}}}}},onUpdate:function(d,g,b,m){this.setSelectStatus(g);var a=Ext.get(this.id+"_"+b+"_"+g.id);if(a){var j=this.findColByName(b);var h=this.getEditor(j,g);if(h!=""&&($(h) instanceof $A.CheckBox)){this.renderEditor(a,g,j,h)}else{var n=this.renderText(g,j,m);a.update(n)}}var o=this.columns;for(var f=0,e=o.length;f<e;f++){var j=o[f];if(j.name!=b){var k=Ext.get(this.id+"_"+j.name+"_"+g.id);if(k){if(j.editorfunction){var h=this.getEditor(j,g);this.renderEditor(k,g,j,h)}if(j.renderer){var n=this.renderText(g,j,g.get(j.name));k.update(n)}}}}this.drawFootBar(b)},onLoad:function(){this.clearBody();var a=this.dataset.data.length;if(a==0){this.createEmptyRow()}for(var b=0;b<a;b++){this.createRow(this.dataset.getAt(b),b)}this.drawFootBar();$A.Masker.unmask(this.wrap);this.fireEvent("render",this)},onValid:function(e,a,b,d){var g=this.findColByName(b);if(g){var f=Ext.get(this.id+"_"+b+"_"+a.id);if(f){if(d==false){f.addClass("item-invalid")}else{f.removeClass([this.nbcls,"item-invalid"])}}}},onAdd:function(c,a,b){this.removeEmptyRow();this.createRow(a,this.dataset.data.length-1);this.selectRow(this.dataset.indexOf(a));this.setSelectStatus(a)},onRemove:function(c,a,b){var d=Ext.get(this.id+"-"+a.id);if(d){d.remove()}this.selectTr=null;$A.Masker.unmask(this.wrap);this.drawFootBar()},clearBody:function(){while(this.tbody.dom.childNodes.length){this.tbody.dom.removeChild(this.tbody.dom.firstChild)}this.emptyRow=null},getDataIndex:function(d){var b=-1;for(var c=0,a=this.dataset.data.length;c<a;c++){var e=this.dataset.getAt(c);if(e.id==d){b=c;break}}return b},onEditorBlur:function(a){if(this.currentEditor&&!this.currentEditor.editor.isEventFromComponent(a.target)){this.hideEditor()}},onMouseWheel:function(b){b.stopEvent();if(this.editing==true){return}var c=b.getWheelDelta(),a=this;if(c>0){a.dataset.pre()}else{if(c<0){a.dataset.next()}}},onIndexChange:function(c,b){var a=this.getDataIndex(b.id);if(a==-1){return}if(b!=this.selectRecord){this.selectRow(a,false)}},onFieldChange:function(d,a,e,b,c){switch(b){case"required":var f=Ext.get(this.id+"_"+e.name+"_"+a.id);if(f){(c==true)?f.addClass(this.nbcls):f.removeClass(this.nbcls)}break}},onBeforeRemove:function(){$A.Masker.mask(this.wrap,_lang["grid.mask.remove"])},onBeforeLoad:function(){$A.Masker.mask(this.wrap,_lang["grid.mask.loading"])},onAfterSuccess:function(){$A.Masker.unmask(this.wrap)},onBeforSubmit:function(a){$A.Masker.mask(this.wrap,_lang["grid.mask.submit"])},onAjaxFailed:function(b,a){$A.Masker.unmask(this.wrap)}});